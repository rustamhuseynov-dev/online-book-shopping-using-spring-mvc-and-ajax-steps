<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8">
	<title>Alıcı</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link th:href="@{/styles/customer.css}" rel="stylesheet">
	<style>

	</style>
</head>

<body>
	<!-- HTML BEGIN -->
	<div th:replace="~{menu :: menu}"></div>
	<div id="main-content">
		
	</div>
	<button id="openBasketBtn" class="btn btn-primary">Səbət <span class="badge badge-light" id="basketBookCount">0</span></button>;
	<input id="searchInput" class="form-control" placeholder="Search">
	<!-- HTML END -->
	<script>
		//JAVASCRIPT BEGIN
		//REFRESH BEGIN
		var xht = new XMLHttpRequest();
		var booksArrayGlobal=[];
		var basketBooks=[];
		var basketBooksFromStorage=localStorage.getItem('basketBooks');
		if(basketBooksFromStorage==null){
			localStorage.setItem('basketBooks','[]');
		}else{
			basketBooks=JSON.parse(basketBooksFromStorage);
		}
		var openBasketButton=document.getElementById('openBasketBtn');
		var basketBookCount=document.getElementById('basketBookCount');
		basketBookCount.innerHTML=basketBooks.length;
		xht.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				var responseJSON = this.responseText
				var booksArray = JSON.parse(responseJSON)
				console.log(booksArray)
				booksArrayGlobal = booksArray.slice();
				var mainContent = document.getElementById('main-content');
				var mainContentHtml="";
				for(var i = 0;i<booksArray.length;i++){
					var book = booksArray[i];
					mainContentHtml+="<div class='book-container'>";
					mainContentHtml+="<div class='book'>";
					mainContentHtml+="<span class='book-image'></span>";
					mainContentHtml+="<span class='book-name' title='"+book.name+"'>"+book.name+"</span>";
					mainContentHtml+="<span class='book-price' title='"+book.price+"'>"+book.price+"</span>";
					mainContentHtml+="<span class='book-description' title='"+book.description+"'>"+book.description+"</span>";
					mainContentHtml+="<span class='book-author' title='"+book.author+"'>"+book.author+"</span>";
					mainContentHtml+="<span class='book-pageCount' title='"+book.pageCount+"'>"+book.pageCount+"</span>";
					mainContentHtml+="<div class='addToBasket'><button class='addToBasketBtn btn btn-primary' onclick='addToBasket("+book.id+")'>Səbətə at</button></div>";
					mainContentHtml+="</div></div>";	
				}
				    mainContent.innerHTML=mainContentHtml;
			}      
		}
		xht.open("GET", "/rest/books", true);
		xht.send()
		//REFRESH END
		//FUNCTION BEGIN
		function addToBasket(bookId){
			var bookExistsInBasket=false;	
			for(var i=0;i<basketBooks.length;i++){
				var basketBook = basketBooks[i]
				if(basketBook.book.id==bookId){
					basketBook.count++;
					bookExistsInBasket=true;
					break;
				}
			}
			if(bookExistsInBasket){
				
			}
			else{
				for(var i = 0;i<booksArrayGlobal.length;i++){
					if(booksArrayGlobal[i].id==bookId){
						var basketBook = {count:1,book:booksArrayGlobal[i]};
						basketBooks.push(basketBook);
						break;
					}
				}
			}
			
			openBasketButton.style.display='none';
			basketBookCount.innerHTML=basketBooks.length;
			localStorage.setItem('basketBooks',JSON.stringify(basketBooks));
			setTimeout(function(){
				openBasketButton.style.display='block';
			},300);
		}
		//FUNCTION END
		//JAVASCRIPT END
	</script>
</body>

</html>